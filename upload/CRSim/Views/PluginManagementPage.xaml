<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="CRSim.Views.PluginManagementPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:CRSim.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:CRSim.Converters"     
    xmlns:converters1="using:CommunityToolkit.WinUI.Converters"
    xmlns:interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"   
    xmlns:winui="using:CommunityToolkit.WinUI"   
    xmlns:viewmodels="using:CRSim.ViewModels"   
    xmlns:models="using:CRSim.Models"  
    xmlns:coremodels="using:CRSim.Core.Models"     
    xmlns:pluginmodels="using:CRSim.Core.Models.Plugin"     
    mc:Ignorable="d"
    Loaded="Page_Loaded"
    d:DataContext="{d:DesignInstance Type=viewmodels:PluginManagementPageViewModel}">
    <Page.Resources>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
        <converters:PluginLoadStatusToVisibilityConverter x:Key="PluginLoadStatusToVisibilityConverter"/>
        <converters1:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Page.Resources>
    <Grid x:Name="ContentPagePane" Margin="36,40,0,36">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <TextBlock Grid.Row="0" Text="{x:Bind ViewModel.PageTitle}" Margin="0,0,0,36"
                   Style="{StaticResource TitleTextBlockStyle}"/>
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <SelectorBar x:Name="SelectorBar" Grid.Column="0" SelectionChanged="SelectorBar_SelectionChanged">
                        <interactivity:Interaction.Behaviors>
                            <interactivity:EventTriggerBehavior EventName="SelectionChanged">
                                <interactivity:InvokeCommandAction Command="{x:Bind ViewModel.SourceSelectedCommand}" CommandParameter="{x:Bind SelectorBar.SelectedItem,Mode=OneWay}"/>
                            </interactivity:EventTriggerBehavior>
                        </interactivity:Interaction.Behaviors>
                        <SelectorBarItem Text="在线" Icon="{winui:FontIcon Glyph=&#xEDE4;}" IsSelected="True"/>
                        <SelectorBarItem Text="本地" Icon="{winui:FontIcon Glyph=&#xEDA2;}" />
                    </SelectorBar>
                    <CommandBar Grid.Column="2" IsOpen="False" DefaultLabelPosition="Right">
                        <AppBarButton Icon="{winui:FontIcon Glyph=&#xE72C;}" Label="刷新" Command="{x:Bind ViewModel.RefreshCommand}"/>
                        <CommandBar.SecondaryCommands>
                            <AppBarButton Icon="{winui:FontIcon Glyph=&#xE8B7;}" Label="打开插件目录" Command="{x:Bind ViewModel.OpenPluginFolderCommand}"/>
                            <AppBarButton Icon="{winui:FontIcon Glyph=&#xE7B8;}" Label="安装外部插件" Command="{x:Bind ViewModel.InstallPluginLocalCommand}"/>
                        </CommandBar.SecondaryCommands>
                    </CommandBar>
                </Grid>
                <Grid Grid.Row="1" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="1.5*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <AutoSuggestBox Grid.Column="0" PlaceholderText="搜索插件" QueryIcon="Find" Text="{x:Bind ViewModel.SearchText,Mode=TwoWay}"
                                    Margin="0,0,8,0" HorizontalAlignment="Stretch" MaxWidth="186.4">
                        <interactivity:Interaction.Behaviors>
                            <interactivity:EventTriggerBehavior EventName="TextChanged">
                                <interactivity:InvokeCommandAction Command="{x:Bind ViewModel.SearchCommand}" />
                            </interactivity:EventTriggerBehavior>
                        </interactivity:Interaction.Behaviors>
                    </AutoSuggestBox>
                    <ComboBox Grid.Column="1" HorizontalAlignment="Stretch" ItemsSource="{x:Bind ViewModel.Authors,Mode=OneWay}"
                              SelectedItem="{x:Bind ViewModel.SelectedAuthor,Mode=TwoWay}">
                        <interactivity:Interaction.Behaviors>
                            <interactivity:EventTriggerBehavior EventName="SelectionChanged">
                                <interactivity:InvokeCommandAction Command="{x:Bind ViewModel.SearchCommand}" />
                            </interactivity:EventTriggerBehavior>
                        </interactivity:Interaction.Behaviors>
                    </ComboBox>
                </Grid>
                <Border Style="{StaticResource ListViewBorder}" Grid.Row="2">
                    <ListView ItemsSource="{x:Bind ViewModel.FilteredPlugins,Mode=OneWay}" Width="290" SelectionMode="Single">
                        <interactivity:Interaction.Behaviors>
                            <interactivity:EventTriggerBehavior EventName="SelectionChanged">
                                <interactivity:InvokeCommandAction Command="{x:Bind ViewModel.PluginSelectedCommand}" />
                            </interactivity:EventTriggerBehavior>
                        </interactivity:Interaction.Behaviors> 
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="pluginmodels:PluginInfo">
                                <StackPanel Orientation="Horizontal" Padding="0,6">
                                    <Border CornerRadius="4">
                                        <Image Width="72" Height="72" Source="{x:Bind RealIconPath}" Margin="0,0,8,0"/>
                                    </Border>
                                    <StackPanel Orientation="Vertical">
                                        <TextBlock Text="{x:Bind Manifest.Name}" Margin="0,0,0,4"/>
                                        <TextBlock Text="{x:Bind Manifest.Description}" TextWrapping="Wrap" MaxWidth="185"
                                                   Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlBackgroundBaseMediumBrush}"/>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Border>
            </Grid>
            <ScrollViewer Grid.Column="1" Padding="16,0,36,0">
                <Grid>
                    <TextBlock Text="请在左侧选择一个插件" Visibility="{x:Bind ViewModel.SelectedPlugin,Mode=OneWay,Converter={StaticResource NullToVisibilityConverter},ConverterParameter=invert}"
                           VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="{ThemeResource SystemControlBackgroundBaseMediumBrush}"/>
                    <StackPanel Orientation="Vertical" Visibility="{x:Bind ViewModel.SelectedPlugin,Mode=OneWay,Converter={StaticResource NullToVisibilityConverter}}">
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Image Grid.Column="0" Height="124" Source="{x:Bind ViewModel.SelectedPlugin.RealIconPath,Mode=OneWay}" HorizontalAlignment="Left"/>
                            <StackPanel Grid.Column="1" Orientation="Vertical" Margin="12,0,0,0">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                    <TextBlock Style="{StaticResource SubtitleTextBlockStyle}" Text="{x:Bind ViewModel.SelectedPlugin.Manifest.Name,Mode=OneWay}" />
                                    <TextBlock Style="{StaticResource CaptionTextBlockStyle}" Text="{x:Bind ViewModel.SelectedPlugin.Manifest.Version, Mode=OneWay}" 
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" VerticalAlignment="Bottom" Margin="4,0,0,0"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                    <HyperlinkButton Content="项目主页" NavigateUri="{x:Bind ViewModel.SelectedPlugin.Manifest.Url,Mode=OneWay}" Style="{StaticResource TextBlockButtonStyle}"/>
                                    <TextBlock Text="{x:Bind ViewModel.SelectedPlugin.Manifest.Author, Mode=OneWay}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
                                    <Button Style="{StaticResource AccentButtonStyle}" Command="{x:Bind ViewModel.RestartCommand}" Visibility="{x:Bind ViewModel.SelectedPlugin.RestartRequired,Mode=OneWay,Converter={StaticResource BoolToVisibilityConverter}}">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <FontIcon Glyph="&#xE777;" Margin="0,0,8,0"/>
                                            <TextBlock Text="重启应用" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Style="{StaticResource AccentButtonStyle}" Command="{x:Bind ViewModel.InstallPluginOnlineCommand}" Visibility="{x:Bind ViewModel.SelectedPlugin,Mode=OneWay,Converter={StaticResource PluginLoadStatusToVisibilityConverter},ConverterParameter=NotLoaded}">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <FontIcon Glyph="&#xE896;" Margin="0,0,8,0"/>
                                            <TextBlock Text="下载" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Command="{x:Bind ViewModel.PackPluginCommand}" Visibility="{x:Bind ViewModel.SelectedPlugin,Mode=OneWay,Converter={StaticResource PluginLoadStatusToVisibilityConverter},ConverterParameter=Loaded}">
                                        <FontIcon Glyph="&#xE72D;" FontSize="16"/>
                                    </Button>
                                    <Button Command="{x:Bind ViewModel.UninstallPluginCommand}" Visibility="{x:Bind ViewModel.SelectedPlugin,Mode=OneWay,Converter={StaticResource PluginLoadStatusToVisibilityConverter},ConverterParameter=Loaded}">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <FontIcon Glyph="&#xE74D;" Margin="0,0,8,0" FontSize="16"/>
                                            <TextBlock Text="卸载" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Command="{x:Bind ViewModel.CancelUninstallPluginCommand}" Visibility="{x:Bind ViewModel.SelectedPlugin.IsUninstalling,Mode=OneWay,Converter={StaticResource BoolToVisibilityConverter}}">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <FontIcon Glyph="&#xE7A7;" Margin="0,0,8,0"/>
                                            <TextBlock Text="撤销" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                                <ProgressBar Value="{x:Bind ViewModel.SelectedPlugin.DownloadProgress,Mode=OneWay}" Visibility="{x:Bind ViewModel.SelectedPlugin.DownloadProgress,Mode=OneWay,Converter={StaticResource IntToVisibilityConverter},ConverterParameter=false}"/>
                            </StackPanel>
                        </Grid>
                        <TextBlock Text="{x:Bind ViewModel.SelectedPlugin.Manifest.Description,Mode=OneWay}"/>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Grid>
    </Grid>
</Page>
